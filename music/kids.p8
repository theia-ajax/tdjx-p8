pico-8 cartridge // http://www.pico-8.com
version 29
__lua__
-- kids - mgmt
-- pico8 cover


cols={0xfc,0xbf,0xab,0xca}
cols={0x0c,0x0f,0x0b,0x0a}
pattern=0x0f0f
colors={2,8,8,9,9,10,10,7,7,7,7}
colors={8,10,11,11,12,12,12,12}
colors={8,9,9,10,10,10}

scrp_1={
	0,137,2,3,4,5,6,7,
	8,9,10,11,12,13,14,136
}

scrp_2={
	0,1,2,3,4,5,6,7,
	8,9,10,11,12,13,14,15
}

scrps={
	scrp_1,scrp_2
}

scrpidx=1

function palswap(p)
	for i=0,15 do
		pal(i,p[i+1] or i,1)
	end
end

function _init()
	poke(0x5f2e,0)

	palswap(scrp_1)

	music(5)
	vol={0,0,0,0}
	objs={}
	queue={}
	
	idx=1
	mxct=80
	for i=1,4 do
		for n=1,mxct do
			local a=8*k_e*n+(i-1)/16
			local rad=3
			local x=cos(a)*rad
 		local y=-n/mxct*4+1
 		local z=sin(a)*rad
 		local r=t()/4
 		local wx=cos(r)*x-sin(r)*z 		local wz=sin(r)*x+cos(r)*z+5
 		local sx=64+64*wx/wz
 		local sy=64+64*y/wz
 		local rad=14-wz+1
 		local col=cols[(i+n)%4+1]
 		local obj={
 			x=x,y=y,z=z,rad=rad,col=col
 		}
 		objs[idx]=obj
 		add(queue,obj)
 		idx+=1
 	end
 end
end

function swap(addr)
	local v=peek(addr)
	if v==0 then
		poke(addr,0xf)
	else
		poke(addr,0x0)
	end
end

function _update()
	for i=0,3 do
		if btnp(i) then
			swap(0x5f40+i)
			scrpidx+=1
			if scrpidx>#scrps then
				scrpidx=1
			end
			palswap(scrps[scrpidx])
		end
	end
	
	idx=1
	for i=1,4 do
		local ct=max(flr((mxct-1)*(vol[i]-2)/63),0)
		for n=1,mxct do
			obj=objs[idx]
			local x=obj.x
 		local y=obj.y
 		local z=obj.z
 		local r=t()/4
 		local wx=cos(r)*x-sin(r)*z
 		local wz=sin(r)*x+cos(r)*z+5
 		obj.sx=64+64*wx/wz
 		obj.sy=64+64*y/wz
			obj.rad=14-wz+1
			obj.show=n<=ct
			idx+=1
 	end
 end
 
	local n=#queue
	for xx=1,12 do
 	for i=1,n-1 do
 		if queue[i].rad>queue[i+1].rad then
 			queue[i],queue[i+1]=
 				queue[i+1],queue[i]
 		end
 	end
 end
end

function lerp(a,b,t)
	return a+(b-a)*t
end
k_e=2.7182
function _draw()
	cls(1)

	draw_volume()

	fillp(pattern)	
	local vsum=0
	for i=1,#vol do
		vsum+=vol[i]
	end
	local vf=vsum/(63*#vol)
	
	for o in all(queue) do
		if o.show then
			circfill(o.sx,o.sy,o.rad,o.col)
			circfill(o.sx+o.rad/2,o.sy-o.rad/2,o.rad/4-1,0x77)
			circ(o.sx,o.sy,o.rad,0)
		end
	end
	
	
	
end



function draw_vol(x,w,v)
	local vv=v/63
	local coltbl=colors
	local n=#coltbl

	for i=0,flr(vv*128),1 do
		local c=coltbl[flr(i/127*n)+1]
		line(x,127-i,x+w,127-i,c)
	end
	
	
end

function getvol(c)
	local i=c+16
	local s,r,v,n=stat(i),stat(i+4),0,nil
	if s >= 0 then
		local a=12800+(s*68)+(r*2)
		n=band(peek(a),63)
		a+=1
		v=band(shr(peek(a),1),7)
	end
	return v,n
end

function ins(a,i,o)
	local n=#a
	assert(i>=1 and i<=n)
	if i==n then
		return add(a,o)
	end
	
	for j=n,i,-1 do
		a[j+1]=a[j]
	end
	a[i]=o
	return o
end

function ins_when(a,o,pred)
	local n=#a
	for i=1,n do
		if pred(o,a[i]) then
			return ins(a,i,o)
		end
	end
	return add(a,o)
end


function draw_volume()
fillp()	
	for i=0,3 do
		local v,n=getvol(i)
		
		v=v+(n or 0)

		vol[i+1]=lerp(vol[i+1],v,0.4)
		
--		local y=128-(vol[i+1]/63*128)
--		rectfill(i*32,y,(i+1)*32,128,7)
		draw_vol(i*32,31,vol[i+1])
	end
end
__sfx__
01040000070500a0500c0500a0500305003050030500a0000a0000a00007000050000a0000c0000a0000500005000050000300000000000000000000000000000000000000000000000000000000000000000000
000100001805016050160500f0500f0500c0500c05000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
010200000c6500a6500a6500a65007650076400563003620036100361003610036140000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000100003562030620000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
011000000c0433f4151b3133f215246430c6433f4151b2130c0431b3133f5153f415246433f2151b2130c6430c0433f1151b2131b313246430c6431b3133f4150c0431b3133f2151b513246430c6433f2150c643
01100020240212403524045240452b0212b0352b0452b041270212703527045270452702527035270452704524021240352404524045330213303533045330452b0212b0352b0452b0452b0252b0352b0452b045
01100000180211803518045180451f0211f0351f0451f0411b0211b0351b0451b0451b0251b0351b0451b04518021180351804518045270212703527045270451f0211f0351f0451f0451f0251f0351f0451f045
011000002d0312d04724035240452d0312d04724035240452b0212b0252b0352b0452b0252b0252b0352b0452b0212b0252b0352b0452d0212d0252d0352d0453302133025330353304533025330253303533045
01040000053550a354073550735400355003540a35307354052000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
011000000e5530e00313655136550e5530e50313655136050e5530e00313655136550e5530e50313655136050e5530e00313655136550e5530e50313655136050e5530e00313655136550e5530e5031365513605
01100000175501742019550194201c5501c4201e5501e4202055521555235552155520555255552655526200175521742019551194201c5511c4201e5511e4202855526555255552655528555235552155521400
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0110000018630166301662013620116200c6200a6200a6100761007610056100561502600116000f6000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
010400040862302020076200202000003000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
010c00001830018100183001810018300181001830018100133001310013300131001330013100133001310011300111001130011100113001110011300111001330013100133001310013300131001330013100
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
010e00002135021350151000000023350233501c000000002535025350203001e300283502835019300003002a3502a35000300003002c3502c3502a3502a3501c3001c300283502835019300193002535225352
010e00002535225352253522535225352253522535225352253522535225352253522535225352253522535223352233522335223352233522335223352233522335223352233522335223352233522335223352
010e0000253522535225352253522535225352253522535225352253522535225352253522535225352253521700017000170001700017000170001700017000106001700010600170000c000170001700017000
010e00000d073103001240012400106751530012400124000d073103001240012400106751530012400124000d073103001240012400106751530012400124000d07310300124001240010675153001240012400
010e00000d073103001240012400106751530012400124000d073103001240012400106751530012400124000d073103001240012400106751530012400106750d0730c0030d0730c00310675153001060512400
010e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000106751700010675170000d073000000000000000
010e00001e2301e23000000000001e2301e230000000000000000000002123021230002000020021230212301e2001e2001e2301e2301e2001e3001e2301e23021230212301e2301e23023230232302523025230
010e00000000000000000000000000000000000000000000000000000000000000000000000000202302023020230202302123021230202302023021230212302323023230212302123020230202301c2301c230
010e00000613006130121301213006130061301213012130061300613012130121300613006130121301213002130021300e1300e13002130021300e1300e13002130021300e1300e13002130021300e1300e130
010e00000913009130151301513009130091301513015130091300913015130151300913009130151301513008130081301413014130081300813014130141300813008130141301413008130081301413014130
010e00000020000200000000000000000000000000000000000000000000000000000000000000000000000026230262302523025230232302323021230212302123021230232302323021230212302023020230
010e00002135021350151000000023350233501c000000002535025350203001e3002335023350193000030021350213500030000300233502335021350213501c3001c3001e3501e35019300193002135221352
010e00002135221352213522135221352213522135221352213522135221352213522135221352213522135200000000000000000000000000000000000000000000000000000000000000000000000000000000
010e00000000000000000000000000000000000000000000000000000000000000000000000000000000000026230262302523025230232302323021230212302123021230232302323021230212301e2301e230
__music__
01 04064344
00 04064344
00 04054344
02 04074344
03 090a4344
00 16195e44
00 17194344
00 16194344
00 181a1b44
01 16191e1c
00 17191f1d
00 16191e1c
00 181a1f20
00 16191e1c
00 17191f1d
00 21191e1c
00 221a1f23
00 41191e44
00 1b1a1f44
00 41191e44
02 1b1a1f44


pico-8 cartridge // http://www.pico-8.com
version 42
__lua__
function _init()
	poke(0x5f2e,1)
	poke(0x5f2d,1)

	play_init()
end

function load_entity(mx,my,m)
	if m==32 then
		mset(mx,my,0)
		spawn_player(mx+0.5,my+.875)
	end
end

function load_level(lx,ly)
	reload(0x2000,1000)

	g.level={
		x=lx or 0,
		y=ly or 0,
	}
	
	for lvx=0,15 do
		for lvy=0,12 do
			local mx,my=g.level.x+lvx,
				g.level.y+lvy
			local m=mget(mx,my)
			if fget(m,1) then
				load_entity(mx,my,m)
			end
		end
	end
end

function spawn_player(x,y)
	g.p=actor:new_char({
		x=x or 0,y=y or 0,
		dx=0,dy=0,
		w=1,h=2,
		face=1,
	})
end

function play_init()
	g={}
	
	load_level(0,0)
	
	palette={
		[0]=0,[1]=1,[2]=2,[3]=3,
		[4]=4,[5]=5,[6]=6,[7]=7,
		[8]=8,[9]=9,[10]=142,[11]=11,
		[12]=12,[13]=13,[14]=14,[15]=15,
 }
	pal(palette,1)

	game_update=play_update
	game_draw=play_draw
end

function keypress(key)
	if key=="l" then
		load_level(0,0)
	end
end

function _update60()
	while stat(30) do
		keypress(stat(31))
	end
	
	game_update()
end

function _draw()
	game_draw()
end

function play_update()
	local ix,iy=0,0
	if (btn(0,0)) ix-=1
	if (btn(1,0)) ix+=1
	if (btn(2,0)) iy-=1
	if (btn(3,0)) iy+=1
	local try_jump=btnp(4,0)
	
	g.p:update_char(ix,iy,try_jump)
end

function play_draw()
	cls()
	local ox=0
	if (g.p.face<0) ox=0
	
	local sx,sy=w2s(g.p.x,g.p.y)
	
	spr(36,sx-8+ox,sy-15,2,2,g.p.face < 0)
	
	local x1,y1,x2,y2=g.p:bounds()
	local sx1,sy1,sx2,sy2=w2s(x1,y1,x2,y2)

	rect(sx1,sy1,sx2,sy2,10)
	
	map(0,0,0,0,16,13)
	
	rectfill(0,104,127,127,0)
end
-->8
actor={
	x=0,y=0,
	dx=0,dy=0,
	w=0.25,h=1,
	face=1,
}
actor.__index=actor

function actor:new(params)
	return setmetatable(
		params or {},actor)
end

function actor:new_char(params)
	params=params or {}
	params.⧗={
		try_jump=0,
		grounded=0,
	}
	return setmetatable(params,actor)
end

function actor:move(mx,my)
	-- restrict motion to the right
	-- if moving right would collide
	local continue=true
	while mx>0 and continue do
--		(solid(
--				self.x+mx+self.w,
--				self.y) or
--			solid(
--				self.x+mx+self.w,
--				self.y-self.h+0.125))
--	do
		local test_x=self.x+mx+self.w

		local lower=solid(
			test_x,
			self.y)
		local upper=solid(
			test_x,
			self.y-self.h+0.125)
		
		continue=lower or upper
			
		if (continue)	mx=moveto(mx,0,0.125)
	end

	-- to the left
	while mx<0 and
		(solid(
				self.x+mx-self.w,
				self.y) or
			solid(
				self.x+mx-self.w,
				self.y-self.h+0.125))
	do
		mx=moveto(mx,0,0.125)
	end
	
	-- downward
	while my>0 and
		(solid(
				self.x-self.w,
				self.y+my) or
			solid(
				self.x+self.w,
				self.y+my))
	do
		my=moveto(my,0,0.125)
	end
	
	-- upward
	while my<0 and
		(solid(
				self.x-self.w,
				self.y-self.h+my) or
			solid(
				self.x+self.w,
				self.y-self.h+my))
	do
		my=moveto(my,0,0.125)
	end
	
	-- update position
	self.x+=mx
	self.y+=my
	
	return mx,my
end

function actor:update_flags()
	local on_ground=solid(
		self.x,self.y+0.125)
	
	if on_ground then
		self.ground⧗=4
	else
		self.ground⧗=moveto(
			self.ground⧗,0,1)
	end
end

function actor:update_char(ix,iy,ijump)
	if ix<0 then	
		self.face=-1
	elseif ix>0 then
		self.face=1
	end
	
	local accel=4/60
	local decay=2/60
	local maxspeed=12/60
	local gravity=1.25/60
	local jumpforce=15/60
	
	if ix~=0 then
		self.dx+=ix*accel
	else
		self.dx=moveto(self.dx,0,decay)
	end
	
	self.dx=mid(
		self.dx,-maxspeed,maxspeed)
	
	self.dy+=gravity
	
	if ijump then
		self.dy=-jumpforce
	end

	self.dx,self.dy=
		self:move(self.dx,self.dy)
		
	self:update_flags(self)
end

function actor:on_ground()
	return self.ground⧗>0
end

function actor:bounds()
	return self.x-self.w,
		self.y-self.h+0.125,
		self.x+self.w,
		self.y
end

function solid(x,y)
	return fget(mget(x,y),0)
end

function w2s(x1,y1,x2,y2)
	x1=x1 or 0
	y1=y1 or 0
	x2=x2 or 0
	y2=y2 or 0
	return x1*8,y1*8,x2*8,y2*8
end

-->8
function moveto(val,to,rate)
	if val<to then
		return min(val+rate,to)
	elseif val>to then
		return max(val-rate,to)
	end
	return val
end

function halt(err)
	cls()
	flip()
	color(7)
	?err
	stop()
end
-->8

__gfx__
00000000000000000000000000000000000000000000000000000000000000006666666600000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000006655556600000000000000000000000000000000000000000000000000000000
00700700000000000000000000000000000000000000000000000000000000006555565600000000000000000000000000000000000000000000000000000000
00077000000000000000000000000000000000000000000000000000000000006555655600000000000000000000000000000000000000000000000000000000
00077000000000000000000000000000000000000000000000000000000000006556555600000000000000000000000000000000000000000000000000000000
00700700000000000000000000000000000000000000000000000000000000006565555600000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000006655556600000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000006666666600000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0aaaaaa00000000000aaaaa0000000000000000000d0000000000000000000000000000000000000000000000000000000000000000000000000000000000000
aaaafaf0000000000aaaaaaa000000000000000000dd000000000000000000000000000000000000000000000000000000000000000000000000000000000000
a0afcfc000000000aaaafaaa00000000000000000ddddd0000000000000000000000000000000000000000000000000000000000000000000000000000000000
00fffff0eeee00000a9fcffc0990000000000000dddeee0000000000000000000000000000000000000000000000000000000000000000000000000000000000
eee222eeee220000099ffff999999900000000000eeeffe000000000000000000000000000000000000000000000000000000000000000000000000000000000
eeeeeeeeeee20000099999999999990000000000eeefcfe000000000000000000000000000000000000000000000000000000000000000000000000000000000
0022220000000000099999999999990000000000eedfff0000000000000000000000000000000000000000000000000000000000000000000000000000000000
00ee0ee00000000000ddddd00000000000000000dddddd0000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000004444ddddd0ddf000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000444dddddd44f4f00000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000444ddddddd444400000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000ddfff000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000fff0000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000fd000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000d0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0000000000000000010000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0808080808080808080808080808080800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0800000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0800000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0820000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0808080808080808080808080808000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0800000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0800000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0800000000000808080808080808080800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0800000000000800000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0800000808080800000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0800000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0800000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0808080808080808080808080808080800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
